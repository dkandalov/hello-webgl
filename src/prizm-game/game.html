<!DOCTYPE html>
<!-- saved from url=(0062)http://threejs.org/examples/webgl_geometry_colors_blender.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="../../script/bmi.js" language="javascript"></script><title>three.js webgl - io blender - vertex colors</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
			body {
				color: #eee;
				font-family:Monospace,serif;
				font-size:13px;
				text-align:center;

				background-color: #000;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a {
				color: #0080ff;
			}

		</style> </head>
<body>
<div id="container"><div id="stats" style="width: 80px; opacity: 0.9; cursor: pointer; position: absolute; top: 0px;">
    <div id="fps" style="padding: 0px 0px 3px 3px; text-align: left; background-color: rgb(0, 0, 34);"><div id="fpsText" style="color: rgb(0, 255, 255); font-family: Helvetica, Arial, sans-serif; font-size: 9px; font-weight: bold; line-height: 15px;">56 FPS (0-60)</div>
        <div id="fpsGraph" style="position: relative; width: 74px; height: 30px; background-color: rgb(0, 255, 255);">
</div></div></div></div>
<!--<div id="info"><a href="http://threejs.org/" target="_blank">three.js</a> webgl - io blender - vertex colors</div>-->
<script src="../../script/three.js"></script>
<script src="../../script/Detector.js"></script>
<script src="../../script/stats.min.js"></script>

<script>
    var directionLeft = -1;
    var directionRight = 1;

    function Bullet() {
        this.x = 0;
        this.y = 0;
        this.visible = false;
        this.direction = 0;
        this.speed = 100;
    }

    Bullet.prototype.shoot = function(x, y, direction) {
        this.visible = true;
        this.x = x;
        this.y = y;
        this.direction = direction;
    };

    Bullet.prototype.update = function(game) {
        if (!this.visible) return;

        this.x += this.speed * this.direction;
        if (this.x < game.fieldLeft) {
            this.visible = false;
        }
        if (this.x > game.fieldRight) {
            this.visible = false;
        }
    };

    function Player(settings) {
        this.x = settings.x;
        this.y = settings.y;
        this.targetX = this.x;
        this.targetY = this.y;
        this.speed = 50;
        this.bullets = [new Bullet(), new Bullet()];
        this.direction = settings.direction;

        var that = this;
        var oldCallback = document.onkeypress;
        document.onkeypress = function(e) {
            e = window.event || e;
            if (String.fromCharCode(e.charCode) == settings.keyUp) {
                that.targetY = that.y + 500;
            }
            if (String.fromCharCode(e.charCode) == settings.keyDown) {
                that.targetY = that.y - 500;
            }
            if (String.fromCharCode(e.charCode) == settings.keyShoot) {
                var bullet = that.takeBullet();
                console.log(bullet)
                if (bullet != null) bullet.shoot(that.x, that.y, settings.direction);
            }

            if (oldCallback != null) oldCallback(e);
        }
    }

    Player.prototype.takeBullet = function() {
        for (var i = 0; i < this.bullets.length; i++) {
            var bullet = this.bullets[i];
            if (!bullet.visible) return bullet;
        }
        return null;
    };

    Player.prototype.update = function(mesh, bulletsMesh, game) {
        if (this.targetY != this.y) {
            if (this.targetY < this.y) this.y -= this.speed;
            if (this.targetY > this.y) this.y += this.speed;
        }
        this.bullets.forEach(function(it) { it.update(game); });

        mesh.position.x = this.x;
        mesh.position.y = this.y;
        for (var i = 0; i < this.bullets.length; i++) {
            bulletsMesh[i].visible = this.bullets[i].visible;
            bulletsMesh[i].position.x = this.bullets[i].x;
            bulletsMesh[i].position.y = this.bullets[i].y;
        }
    };

    function Game() {
        this.fieldLeft = -6000;
        this.fieldRight = 6000;
    }


    if (!Detector.webgl) Detector.addGetWebGLMessage();

    var container, stats;
    var camera, scene, renderer;
    var mesh3, light;
    var mouseX = 0, mouseY = 0;

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;

    var player1Mesh, bulletsMesh1;
    var player2Mesh, bulletsMesh2;

    var game;
    var player1;
    var player2;

    init();
    animate();

    function init() {
        container = document.getElementById('container');

        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.z = 9000;

        scene = new THREE.Scene();

        light = new THREE.DirectionalLight(0xffffff);
        light.position.set(0, 0, 1).normalize();
        scene.add(light);

        game = new Game();

        var loader = new THREE.JSONLoader();
        loader.load("../../script/cubecolors.json", createPlayer1);
        bulletsMesh1 = createBulletsMesh();
        player1 = new Player({
            "x": game.fieldRight - 1000,
            "y": 0,
            "direction": directionLeft,
            "keyUp": "i", "keyDown": "k", "keyShoot": "j"
        });

        loader.load("../../script/cube_fvc.json", createScene2);
        player2 = new Player({
            "x": game.fieldLeft + 1000,
            "y": 0,
            "direction": directionRight,
            "keyUp": "w", "keyDown": "s", "keyShoot": "d"
        });
        bulletsMesh2 = createBulletsMesh();

        bulletsMesh1.forEach(function(it) { scene.add(it); });
        bulletsMesh2.forEach(function(it) { scene.add(it); });

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);

        container.appendChild(renderer.domElement);

        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        container.appendChild(stats.domElement);

        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function createBulletsMesh() {
        return [null, null].map(function() {
            var geometry = new THREE.CubeGeometry(100, 100, 100);
            var material = new THREE.MeshNormalMaterial();
            return new THREE.Mesh(geometry, material);
        });
    }
    function createPlayer1(geometry, materials) {
        materials[0].shading = THREE.FlatShading;

        player1Mesh = new THREE.Object3D();
        player1Mesh.position.x = 400;
        player1Mesh.scale.x = player1Mesh.scale.y = player1Mesh.scale.z = 250;

        scene.add(player1Mesh);

        var part1 = new THREE.Mesh(geometry, new THREE.MeshFaceMaterial(materials));
        player1Mesh.add(part1);

        var part2 = new THREE.Mesh(geometry, new THREE.MeshLambertMaterial({
            color: 0xffffff,
            opacity: 0.9,
            shading: THREE.FlatShading,
            wireframe: true,
            wireframeLinewidth: 2,
            transparent: true
        }));
        player1Mesh.add(part2);
    }

    function createScene2(geometry, materials) {
        materials[0].shading = THREE.FlatShading;

        player2Mesh = new THREE.Mesh(geometry, new THREE.MeshFaceMaterial(materials));
        player2Mesh.position.x = -400;
        player2Mesh.scale.x = player2Mesh.scale.y = player2Mesh.scale.z = 250;
        scene.add(player2Mesh);
    }

    function onDocumentMouseMove(event) {
        mouseX = event.clientX - windowHalfX;
        mouseY = event.clientY - windowHalfY;
    }

    function animate() {
        requestAnimationFrame(animate);

        if (player1Mesh != null) player1.update(player1Mesh, bulletsMesh1, game);
        if (player2Mesh != null) player2.update(player2Mesh, bulletsMesh2, game);

        render();
        stats.update();
    }

    function render() {
        camera.position.x += (mouseX - camera.position.x) * 0.05;
        camera.position.y += (-mouseY - camera.position.y) * 0.05;

        camera.lookAt(scene.position);

/*        if (player1Mesh) {
            player1Mesh.rotation.x += 0.01;
            player1Mesh.rotation.y += 0.01;
        }

        if (player2Mesh) {
            player2Mesh.rotation.x += 0.01;
            player2Mesh.rotation.y += 0.01;
        }*/

        renderer.render(scene, camera);
    }

</script>
<script language="javascript"><!--
bmi_SafeAddOnload(bmi_load,"bmi_orig_img",0);//-->
</script></body></html>